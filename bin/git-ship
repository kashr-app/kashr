#!/bin/bash
# Enable auto-merge with rebase for the current PR

set -e

BRANCH=$(git branch --show-current)

if [ "$BRANCH" = "main" ]; then
    echo "✗ Error: Cannot ship from main branch"
    echo "  Switch to a feature branch first: git checkout feature/name"
    exit 1
fi

echo "→ Checking for open PR on branch: $BRANCH..."

# Check if an open PR exists for the current branch
if ! PR_DATA=$(gh pr view --json url,title,state 2>&1); then
    echo "✗ Error: No PR found for branch '$BRANCH'"
    echo "  Create a PR first with: bin/git-pr changelog:<type>"
    exit 1
fi

# Check if the PR is open
PR_STATE=$(echo "$PR_DATA" | jq -r .state)
if [ "$PR_STATE" != "OPEN" ]; then
    echo "✗ Error: PR for branch '$BRANCH' is $PR_STATE (not open)"
    echo "  Create a new PR with: bin/git-pr changelog:<type>"
    exit 1
fi

# Show which PR we found
PR_TITLE=$(echo "$PR_DATA" | jq -r .title)
PR_URL=$(echo "$PR_DATA" | jq -r .url)
echo "  Found PR: $PR_TITLE"
echo "  URL: $PR_URL"

echo "→ Switching to main..."
git checkout main

echo "→ Pulling latest changes..."
git pull --prune

echo "→ Attempting fast-forward merge of $BRANCH..."
if git merge --ff-only "$BRANCH"; then
    echo "✓ Merge successful"
    
    echo "→ Pushing to origin/main..."
    git push origin main

    echo "→ Deleting local branch $BRANCH..."
    git branch -d "$BRANCH"

    echo "→ Deleting remote branch..."
    if ! git push origin --delete "$BRANCH" 2>/dev/null; then
        echo "  (Remote branch already deleted or doesn't exist)"
    fi

    echo "✓ Done! Branch $BRANCH has been merged and cleaned up."
else
    echo "✗ Fast-forward merge failed!"
    echo "  This means main has diverged. You need to rebase your branch first:"
    echo "  git checkout $BRANCH"
    echo "  git rebase main"
    echo "  git push --force-with-lease"
    exit 1
fi
