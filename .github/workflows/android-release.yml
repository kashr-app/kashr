name: Android Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version tag (e.g., v1.0.0)'
        required: false

jobs:
  build:
    name: Build APK
    runs-on: ubuntu-latest

    permissions:
      contents: read

    outputs:
      version_name: ${{ steps.version.outputs.version_name }}
      version_code: ${{ steps.version.outputs.version_code }}
      flutter_version: ${{ steps.fvm.outputs.flutter_version }}
      release_tag: ${{ steps.tag.outputs.tag }}
      apk_filename: ${{ steps.filename.outputs.apk_filename }}
      artifact_name: ${{ steps.filename.outputs.artifact_name }}
      apk_sha256: ${{ steps.hash.outputs.sha256 }}

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: ./.github/actions/build_setup

      - name: Get dependencies
        shell: bash
        run: flutter pub get

      - name: Run code generation
        shell: bash
        run: dart run build_runner build --delete-conflicting-outputs

      - name: Setup Android signing
        run: |
          # Create signing directory
          mkdir -p android/signing

          # Decode and save keystore
          echo "${{ secrets.ANDROID_KEYSTORE_GITHUB_BASE64 }}" | base64 -d > android/signing/signing.keystore

          # Create signing.properties file
          cat > android/signing/signing.properties << EOF
          STORE_PASSWORD=${{ secrets.ANDROID_STORE_PASSWORD_GITHUB }}
          KEY_ALIAS=${{ secrets.ANDROID_KEY_ALIAS_GITHUB }}
          KEY_PASSWORD=${{ secrets.ANDROID_KEY_PASSWORD_GITHUB }}
          EOF

      - name: Build APK
        env:
          CI: true
        run: flutter build apk --release

      - name: Extract version from pubspec.yaml
        id: version
        run: |
          VERSION=$(grep '^version:' pubspec.yaml | sed 's/version: *//' | tr -d '\r')
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "version_name=$(echo $VERSION | cut -d'+' -f1)" >> $GITHUB_OUTPUT
          echo "version_code=$(echo $VERSION | cut -d'+' -f2)" >> $GITHUB_OUTPUT

      - name: Determine release tag
        id: tag
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ] && [ -n "${{ github.event.inputs.version }}" ]; then
            echo "tag=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
          elif [ "${{ github.event_name }}" == "push" ]; then
            echo "tag=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
          else
            echo "tag=v${{ steps.version.outputs.version_name }}" >> $GITHUB_OUTPUT
          fi

      - name: Set APK filename variables
        id: filename
        run: |
          APK_FILENAME="kashr-${{ steps.tag.outputs.tag }}+${{ steps.version.outputs.version_code }}-release.apk"
          ARTIFACT_NAME="kashr-${{ steps.tag.outputs.tag }}+${{ steps.version.outputs.version_code }}-release-apk"
          echo "apk_filename=$APK_FILENAME" >> $GITHUB_OUTPUT
          echo "artifact_name=$ARTIFACT_NAME" >> $GITHUB_OUTPUT

      - name: Rename APK
        run: |
          mkdir -p release
          cp build/app/outputs/flutter-apk/app-release.apk \
             release/${{ steps.filename.outputs.apk_filename }}

      - name: Compute APK SHA256
        id: hash
        run: |
          cd release
          SHA256=$(sha256sum ${{ steps.filename.outputs.apk_filename }} | awk '{print $1}')
          echo "sha256=$SHA256" >> $GITHUB_OUTPUT
          echo "SHA256: $SHA256"
          # Create .sha256 file
          echo "$SHA256  ${{ steps.filename.outputs.apk_filename }}" > ${{ steps.filename.outputs.apk_filename }}.sha256
          cd ..

      - name: Upload APK artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.filename.outputs.artifact_name }}
          path: |
            release/${{ steps.filename.outputs.apk_filename }}
            release/${{ steps.filename.outputs.apk_filename }}.sha256
          retention-days: 30

  release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    needs: build

    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download APK artifact
        uses: actions/download-artifact@v4
        with:
          name: ${{ needs.build.outputs.artifact_name }}
          path: release

      - name: Generate release notes
        id: notes
        run: |
          # Generate release notes using GitHub CLI
          gh api repos/${{ github.repository }}/releases/generate-notes \
            -f tag_name="${{ needs.build.outputs.release_tag }}" \
            -q .body > auto_notes.md
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Create release notes footer
        id: footer
        run: |
          cat > release_footer.md << 'EOF'

          ---

          ## ðŸ“¥ Installation
          Download the APK file below and install it on your Android device.

          **Note:** You may need to enable "Install from Unknown Sources" in your device settings.

          ## ðŸ” Security Verification

          ### APK SHA-256 Hash
          ```
          ${{ needs.build.outputs.apk_sha256 }}
          ```

          **Verify the downloaded APK:**
          ```bash
          # Linux/macOS - verify against .sha256 file
          sha256sum -c ${{ needs.build.outputs.apk_filename }}.sha256

          # Or manually compare
          sha256sum ${{ needs.build.outputs.apk_filename }}

          # Windows (PowerShell)
          Get-FileHash ${{ needs.build.outputs.apk_filename }} -Algorithm SHA256
          ```

          ### Signing Certificate Fingerprints
          All official releases are signed with our release certificate. Verify using:
          ```bash
          apksigner verify --print-certs ${{ needs.build.outputs.apk_filename }}
          ```

          *Expected SHA-256 fingerprint:*
          ```
          A9:E0:42:FB:F2:AB:1C:4A:B0:FD:46:AD:61:C0:35:74:9A:FA:1D:8D:B6:8D:7E:6A:E6:85:1F:1D:DC:54:CF:59
          ```

          *Expected SHA-1 fingerprint:*
          ```
          E5:65:E1:2E:80:6E:C3:B5:E8:74:38:59:2A:BE:72:41:48:01:C8:65
          ```

          ðŸ“– For more security information, see [SECURITY.md](https://github.com/kashr-app/kashr/blob/main/SECURITY.md).
          EOF

      - name: Combine notes and footer
        run: |
          cat auto_notes.md release_footer.md > final_body.md

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ needs.build.outputs.release_tag }}
          name: Kashr ${{ needs.build.outputs.release_tag }}
          body_path: final_body.md
          files: |
            release/${{ needs.build.outputs.apk_filename }}
            release/${{ needs.build.outputs.apk_filename }}.sha256
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
